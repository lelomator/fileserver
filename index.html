<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Upload</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=delete" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</head>
<body>

  <h2>Ziehe eine Datei oder einen Ordner, um sie hochzuladen</h2>
  
  <div id="drop-area">
    <form id="upload-form" action="/upload" method="POST" enctype="multipart/form-data">
      <input type="file" id="fileElem" name="files" multiple webkitdirectory required>
      <label for="fileElem">Datei oder Ordner hierhin ziehen oder anklicken, um eine Datei oder einen Ordner auszuwählen</label>
      <button type="button" id="uploadBtn">Hochladen</button>
    </form>
  </div>

  <h3>Hochgeladene Dateien:</h3>
  <ul id="file-list"></ul>

  <script>
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileElem');
    const dropArea = document.getElementById('drop-area');

    uploadBtn.addEventListener('click', zipAndUploadFiles);

    // Funktion zum Zippen der Dateien und Upload
    function zipAndUploadFiles() {
      const files = fileInput.files;
      if (!files.length) {
        alert('Bitte wähle Dateien oder einen Ordner zum Hochladen aus.');
        return;
      }

      const zip = new JSZip();
      const folder = zip.folder('upload'); // Ordner in der ZIP-Datei

      // Dateien zum ZIP-Ordner hinzufügen
      Array.from(files).forEach(file => {
        folder.file(file.webkitRelativePath || file.name, file);
      });

      // ZIP-Datei generieren
      zip.generateAsync({ type: 'blob' }).then(function (content) {
        const formData = new FormData();
        formData.append('file', content, 'upload.zip');

        // Datei hochladen
        fetch('/upload', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          console.log('Upload erfolgreich:', data);
          loadFileList();
        })
        .catch(err => console.error('Fehler beim Hochladen:', err));
      });
    }

    // Liste der Dateien laden
    function loadFileList() {
      fetch('/files')
        .then(response => response.json())
        .then(files => {
          const fileList = document.getElementById('file-list');
          fileList.innerHTML = '';
          files.forEach(file => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = `/download/${file}`;
            a.textContent = file;
            a.download = file;

            const deleteIcon = document.createElement('span');
            deleteIcon.className = 'material-symbols-outlined';
            deleteIcon.textContent = 'delete';
            deleteIcon.onclick = () => deleteFile(file);

            li.appendChild(a);
            li.appendChild(deleteIcon);
            fileList.appendChild(li);
          });
        });
    }

    // Datei löschen
    function deleteFile(filename) {
      if (confirm(`Möchtest du die Datei "${filename}" wirklich löschen?`)) {
        fetch(`/delete/${filename}`, {
          method: 'DELETE',
        })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            loadFileList();
          } else {
            alert('Löschen der Datei fehlgeschlagen');
          }
        });
      }
    }

    loadFileList();
  </script>

</body>
</html>
